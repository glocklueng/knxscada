<!DOCTYPE html>
<html xmlns:wicket="http://wicket.apache.org">
	<wicket:head>

	</wicket:head>
    <body>
        <wicket:panel>
        	<script>
        		var currentSize = 200;
        		$(function(){
        			loadElementsPanel();
        			loadSettingsPanel();
        			$("#content").css("overflow","auto");
        			
        		});
        		
        		function loadSettingsPanel(){
        			$( "#sublayer-settings-accordion" ).accordion({
      			      heightStyle: "content",
      			      collapsible: true
      				});
        			
        			$("#settings-area-trigger").click(function(e){
        				$(".settings-panel").toggle();
       					var elementsDisplay = $(".settings-panel").css("display");
           				if(elementsDisplay == "block"){
           					$(".elements-panel").hide();
   	        				setElementPanelVisible();
           				}else{
           					setElementPanelHide();
           				}	
        			});
        			
        			$('#background-image-file').on("change", function(){
        				showLoadingPanel();
            			$("#background-image-submit-button").click();
            		});
        			
        			$("#background-image-choose-button").click(function(e){
            			$("#background-image-file").click();
            		});
        		}
        		
        		function loadElementsPanel(){
        			$( "#elements-area" ).resizable({
        			    maxWidth: 500,
        			    minWidth: 200,
        				handles: "w",
        				resize: function (event, ui) {
        					$( "#elements-area" ).css("left", '0');
        		        },
        		        start: function (event, ui) {
        		        	$("#content").css("overflow","hidden");
        		        },
        		        stop: function (event, ui) {
        		        	$("#content").css("overflow","auto");
        		        	currentSize = ui.size.width;
        		        }
        			});
        			
        			$("#elements-area-trigger").click(function(e){
        				$(".elements-panel").toggle();
       					var elementsDisplay = $(".elements-panel").css("display");
           				if(elementsDisplay == "block"){
           					$(".settings-panel").hide();
   	        				setElementPanelVisible();
           				}else{
           					setElementPanelHide();
           				}	
        			});
 
        			initDragAndDrop();
        			setElementPanelHide();
        		}
        		
        		function initDragAndDrop(){
        			$( ".draggable-element" ).draggable({ 
        				scroll: true,
        				helper: "clone",
        				start: function( event, ui ) {},
        				stop: function( event, ui ) {}
        			});
        			
        			$(".dragged-element").each(function(){
        				makeElementRemovable(this);
        			});
        			
        			$("#content").droppable({
        				  accept: ".draggable-element",
        			      drop: function( event, ui ) {
        			      	var x = ui.offset.left - 195;
          					var y = ui.offset.top - 140;
							var isDraggableElement = $(ui.draggable).hasClass("draggable-element");
          					if(isDraggableElement){
	          					var element = $(ui.draggable).clone();
	          					$(element).css("position", "absolute");
	          					$(element).css("top", y);
	           					$(element).css("left", x);
	           					$(element).addClass("dragged-element");
	           					$(element).removeClass("draggable-element");
	           					
	           					makeElementRemovable(element);
	          					$(this).append(element);
	          					
          					}
          					
          					var callback = $(element).attr("callback");
          					var elementid = $(element).attr("elementid");
          					changeElementPosition(callback, elementid, x, y);
          					
        			      }
        			});
        			$("#elements-area").droppable({
        				greedy: true
        			});
        		}
        		
        		function changeElementPosition(callback, elementid, x, y){
        			
        			var data = {
        					id : elementid,
        					x  : x,
        					y  : y
        			};
        			
        			sendJSONData(callback, data);
        		}
        		
				function removeElement(callback, elementid){
        			
        			var data = {
        					id : elementid
        			};
        			
        			sendJSONData(callback, data);
        		}
				
				function sendJSONData(callback, data){
					$.ajax({
        				url : callback,
        				type : 'post',
        				cache : false,

        				data : $.toJSON(data),
        				contentType : 'application/json',
        				dataType : 'json',
        				complete : function(xhr, status) {
        					
        				}
        			});
				}
        		
        		function setElementPanelHide(){
        			$("#elements-area").resizable( "option", "disabled", true );
       				$("#elements-area").css("width","20px");
       				$("#triggers").css("left", "-2px");
        		}
        		
        		function setElementPanelVisible(){
        			$("#elements-area").css("width",currentSize+"px");
       				$("#elements-area").resizable( "option", "disabled", false );
       				$("#triggers").css("left", "-24px");
        		}
        		
        	</script>
        	
			<div wicket:id="msg" id="msg"></div>
			
			<div class="background-image-div">
				<img wicket:id="background-image" class="background-image"/>
			</div>
			
			<div id="elements-area">
				<div id="triggers">
					<div id="elements-area-trigger-wrapper" class="trigger-wrapper">
						<div id="elements-area-trigger" class="trigger"
							onmouseover="setFocused(this);" 
							onmouseout="unsetFocused(this);">
							<span><wicket:message key="elements-trigger-label"></wicket:message></span>
						</div>
					</div>
					<div id="settings-area-trigger-wrapper" class="trigger-wrapper">
						<div id="settings-area-trigger" class="trigger"
							onmouseover="setFocused(this);" 
							onmouseout="unsetFocused(this);">
							<span><wicket:message key="settings"></wicket:message></span>
						</div>
					</div>
				</div>

				<div wicket:id="elements-panel" class="elements-panel"></div>
				<div wicket:id="settings-panel" class="settings-panel"></div>
			</div>

        </wicket:panel>
        
    </body>
</html>